from PyQt5.QtGui import QColor
from PyQt5.QtWidgets import (
    QWidget, QPushButton, QHBoxLayout, QVBoxLayout,
    QLabel, QSlider, QStackedWidget, QFrame, QProgressBar, QScrollArea, QSplitter, QCheckBox, QGraphicsScene
)

from PyQt5.QtCore import Qt
from crop_widgets import DrawWidget
from config import HUD_ELEMENT_MAPPINGS, UNIFIED_STYLESHEET, UI_LAYOUT, UI_COLORS
from portrait_view import PortraitView

class Ui_CropApp:
    def setupUi(self, CropAppWindow):
        CropAppWindow.setWindowTitle("Fortnite Crop Tool")
        CropAppWindow.resize(1800, 900)
        main_layout = QHBoxLayout(CropAppWindow)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)
        splitter = QSplitter(Qt.Horizontal)
        main_layout.addWidget(splitter)
        left_pane_widget = QFrame()
        left_pane_layout = QVBoxLayout(left_pane_widget)
        left_pane_layout.setContentsMargins(0, 0, 0, 0)
        left_pane_layout.setSpacing(0)
        CropAppWindow.wizard_frame = QFrame()
        CropAppWindow.wizard_frame.setObjectName("wizardFrame")
        left_pane_layout.addWidget(CropAppWindow.wizard_frame)
        wizard_layout = QVBoxLayout(CropAppWindow.wizard_frame)
        wizard_layout.setContentsMargins(20, 12, 20, 12)
        wizard_layout.setSpacing(8)
        CropAppWindow.hud_elements = list(HUD_ELEMENT_MAPPINGS.values())
        CropAppWindow.progress_bar = QProgressBar()
        CropAppWindow.progress_bar.setStyleSheet(f"""
            QProgressBar {{
                border: 1px solid {UI_COLORS.BORDER_DARK};
                border-radius: 6px;
                background-color: {UI_COLORS.BACKGROUND_DARK};
                text-align: center;
                color: {UI_COLORS.TEXT_SECONDARY};
                height: {UI_LAYOUT.PROGRESS_BAR_HEIGHT}px;
            }}
            QProgressBar::chunk {{
                background-color: {UI_COLORS.ACCENT};
                border-radius: 6px;
            }}
        """)
        wizard_layout.addWidget(CropAppWindow.progress_bar)
        CropAppWindow.view_stack = QStackedWidget()
        left_pane_layout.addWidget(CropAppWindow.view_stack, 1)
        CropAppWindow.video_frame = QWidget()
        CropAppWindow.video_frame.setObjectName("videoFrame")
        video_frame_layout = QVBoxLayout(CropAppWindow.video_frame)
        video_frame_layout.setContentsMargins(0, 0, 0, 0)
        video_frame_layout.setSpacing(0)
        CropAppWindow.upload_hint_container = QFrame(CropAppWindow.video_frame)
        CropAppWindow.upload_hint_container.setObjectName("uploadHintContainer")
        CropAppWindow.upload_hint_container.setAttribute(Qt.WA_TransparentForMouseEvents, True)
        hint_layout = QVBoxLayout(CropAppWindow.upload_hint_container)
        hint_layout.setContentsMargins(18, 12, 18, 12)
        hint_layout.setSpacing(0)
        CropAppWindow.upload_hint_label = QLabel("Please Upload Video to Begin!")
        CropAppWindow.upload_hint_label.setObjectName("uploadHintLabel")
        CropAppWindow.upload_hint_label.setAlignment(Qt.AlignCenter)
        hint_layout.addWidget(CropAppWindow.upload_hint_label)
        video_frame_layout.addStretch(1)
        video_frame_layout.addWidget(CropAppWindow.upload_hint_container, 0, Qt.AlignCenter)
        video_frame_layout.addStretch(1)
        CropAppWindow.view_stack.addWidget(CropAppWindow.video_frame)
        CropAppWindow.draw_scroll_area = QScrollArea()
        CropAppWindow.draw_scroll_area.setObjectName("drawScrollArea")
        CropAppWindow.draw_widget = DrawWidget()
        CropAppWindow.draw_scroll_area.setWidget(CropAppWindow.draw_widget)
        CropAppWindow.draw_scroll_area.setWidgetResizable(False)
        CropAppWindow.draw_scroll_area.setAlignment(Qt.AlignCenter)
        CropAppWindow.draw_scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        CropAppWindow.draw_scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        CropAppWindow.draw_scroll_area.setFrameShape(QFrame.NoFrame)
        CropAppWindow.draw_widget.set_scroll_area(CropAppWindow.draw_scroll_area)
        CropAppWindow.view_stack.addWidget(CropAppWindow.draw_scroll_area)
        CropAppWindow.slider_container = QFrame()
        CropAppWindow.slider_container.setObjectName("sliderContainer")
        left_pane_layout.addWidget(CropAppWindow.slider_container)
        slider_layout = QHBoxLayout(CropAppWindow.slider_container)
        slider_layout.setContentsMargins(10, 4, 10, 4)
        slider_layout.setSpacing(12)
        CropAppWindow.position_slider = QSlider(Qt.Horizontal)
        CropAppWindow.position_slider.setRange(0, 1000)
        CropAppWindow.position_slider.setEnabled(False)
        CropAppWindow.current_time_label = QLabel("00:00")
        CropAppWindow.current_time_label.setAlignment(Qt.AlignCenter)
        CropAppWindow.total_time_label = QLabel("00:00")
        CropAppWindow.total_time_label.setAlignment(Qt.AlignCenter)
        slider_layout.addWidget(CropAppWindow.current_time_label)
        slider_layout.addWidget(CropAppWindow.position_slider, 1)
        slider_layout.addWidget(CropAppWindow.total_time_label)
        CropAppWindow.controls_frame = QFrame()
        CropAppWindow.controls_frame.setObjectName("controlsFrame")
        left_pane_layout.addWidget(CropAppWindow.controls_frame)
        controls_layout = QHBoxLayout(CropAppWindow.controls_frame)
        controls_layout.setContentsMargins(10, 4, 10, 14)
        controls_layout.setSpacing(30)
        CropAppWindow.open_button = QPushButton("UPLOAD VIDEO")
        CropAppWindow.open_button.setToolTip("Click to select and load a Fortnite gameplay video file.")
        CropAppWindow.snapshot_button = QPushButton("START CROPPING")
        CropAppWindow.snapshot_button.setToolTip("Freezes the current video frame and opens the drawing tools.")
        CropAppWindow.magic_wand_button = QPushButton("🪄 MAGIC WAND")
        CropAppWindow.magic_wand_button.setToolTip("Automatically detects common HUD elements like Loot and HP in the current frame.")
        CropAppWindow.play_pause_button = QPushButton("▶ PLAY")
        CropAppWindow.play_pause_button.setToolTip("Toggle video playback to find the perfect frame.")
        CropAppWindow.return_button = QPushButton("RETURN TO MAIN APP")
        CropAppWindow.return_button.setToolTip("Closes the crop tool and returns to the primary editor.")
        CropAppWindow.reset_state_button = QPushButton("RESET ALL")
        CropAppWindow.reset_state_button.setToolTip("Clears all progress and restores original HUD coordinates.")
        left_controls = QHBoxLayout()
        left_controls.setSpacing(20)
        left_controls.addWidget(CropAppWindow.open_button)
        left_controls.addWidget(CropAppWindow.snapshot_button)
        left_controls.addWidget(CropAppWindow.magic_wand_button)
        right_controls = QHBoxLayout()
        right_controls.setSpacing(20)
        right_controls.addWidget(CropAppWindow.return_button)
        right_controls.addWidget(CropAppWindow.reset_state_button)
        controls_layout.addLayout(left_controls)
        controls_layout.addStretch(1)
        controls_layout.addWidget(CropAppWindow.play_pause_button)
        controls_layout.addStretch(1)
        controls_layout.addLayout(right_controls)
        right_pane_widget = QFrame()
        right_pane_widget.setObjectName("portraitPane")
        right_pane_layout = QVBoxLayout(right_pane_widget)
        right_pane_layout.setContentsMargins(0, 0, 0, 0)
        right_pane_layout.setSpacing(6)
        portrait_header = QFrame()
        portrait_header.setObjectName("portraitHeader")
        right_pane_layout.addWidget(portrait_header)
        portrait_header_layout = QHBoxLayout(portrait_header)
        portrait_header_layout.setContentsMargins(10, 4, 10, 4)
        portrait_header_layout.setSpacing(20)
        CropAppWindow.status_label = QLabel("Fix Size & Position of HUD Elements:")
        CropAppWindow.status_label.setAlignment(Qt.AlignCenter)
        CropAppWindow.snap_toggle_button = QPushButton("🧲 SNAP")
        CropAppWindow.snap_toggle_button.setCheckable(True)
        CropAppWindow.snap_toggle_button.setChecked(True)
        CropAppWindow.snap_toggle_button.setToolTip("Toggle magnetic snapping. When OFF, visual alignment guides still appear.")
        CropAppWindow.show_placeholders_checkbox = QCheckBox("Show Existing Crops")
        CropAppWindow.show_placeholders_checkbox.setChecked(False)
        CropAppWindow.show_placeholders_checkbox.setToolTip("Toggles visibility of previously saved HUD element locations.")
        CropAppWindow.done_button = QPushButton("FINISH & SAVE")
        CropAppWindow.done_button.setToolTip("Surgically updates the configuration file with your new HUD placements.")
        portrait_header_layout.addWidget(CropAppWindow.status_label)
        portrait_header_layout.addStretch()
        portrait_header_layout.addWidget(CropAppWindow.snap_toggle_button)
        portrait_header_layout.addWidget(CropAppWindow.show_placeholders_checkbox)
        portrait_header_layout.addWidget(CropAppWindow.done_button)
        CropAppWindow.portrait_scene = QGraphicsScene(CropAppWindow)
        CropAppWindow.portrait_scene.setSceneRect(0, 0, UI_LAYOUT.PORTRAIT_BASE_WIDTH, UI_LAYOUT.PORTRAIT_BASE_HEIGHT)
        CropAppWindow.portrait_scene.setBackgroundBrush(QColor(UI_COLORS.BACKGROUND_DARK))
        CropAppWindow.portrait_view = PortraitView(CropAppWindow.portrait_scene)
        right_pane_layout.addWidget(CropAppWindow.portrait_view, 1)
        portrait_footer = QFrame()
        portrait_footer.setObjectName("portraitFooter")
        right_pane_layout.addWidget(portrait_footer)
        portrait_footer_layout = QHBoxLayout(portrait_footer)
        portrait_footer_layout.setContentsMargins(10, 4, 10, 14)
        portrait_footer_layout.setSpacing(20)
        CropAppWindow.delete_button = QPushButton("DELETE")
        CropAppWindow.delete_button.setToolTip("Removes the currently selected HUD element from the portrait composer.")
        CropAppWindow.undo_button = QPushButton("UNDO")
        CropAppWindow.undo_button.setToolTip("Reverts your last change (Ctrl+Z).")
        CropAppWindow.redo_button = QPushButton("REDO")
        CropAppWindow.redo_button.setToolTip("Re-applies your last undone change (Ctrl+Y).")
        portrait_footer_layout.addStretch()
        portrait_footer_layout.addWidget(CropAppWindow.delete_button)
        portrait_footer_layout.addWidget(CropAppWindow.undo_button)
        portrait_footer_layout.addWidget(CropAppWindow.redo_button)
        portrait_footer_layout.addStretch()
        splitter.addWidget(left_pane_widget)
        splitter.addWidget(right_pane_widget)
        splitter.setSizes([1000, 800])
        CropAppWindow.controls_frame.setFixedHeight(UI_LAYOUT.BUTTON_HEIGHT + 22)
        portrait_header.setFixedHeight(UI_LAYOUT.BUTTON_HEIGHT + 12)
        portrait_footer.setFixedHeight(UI_LAYOUT.BUTTON_HEIGHT + 22)
        self.setup_styles(CropAppWindow)

    def setup_styles(self, CropAppWindow):
        CropAppWindow.setStyleSheet(UNIFIED_STYLESHEET)
        CropAppWindow.setObjectName("CropAppWindow")
        CropAppWindow.open_button.setProperty('class', 'primary large')
        CropAppWindow.snapshot_button.setProperty('class', 'accent')
        CropAppWindow.magic_wand_button.setProperty('class', 'primary')
        CropAppWindow.play_pause_button.setProperty('class', '')
        CropAppWindow.return_button.setProperty('class', 'warning')
        CropAppWindow.reset_state_button.setProperty('class', 'danger')
        CropAppWindow.done_button.setProperty('class', 'success')
        CropAppWindow.delete_button.setProperty('class', 'danger')
        CropAppWindow.undo_button.setProperty('class', 'primary')
        CropAppWindow.redo_button.setProperty('class', 'primary')
        for btn in [CropAppWindow.open_button, CropAppWindow.snapshot_button, CropAppWindow.magic_wand_button,
                    CropAppWindow.play_pause_button, CropAppWindow.return_button, CropAppWindow.reset_state_button,
                    CropAppWindow.done_button, CropAppWindow.delete_button, CropAppWindow.undo_button, CropAppWindow.redo_button,
                    CropAppWindow.snap_toggle_button]:
            btn.setFixedHeight(UI_LAYOUT.BUTTON_HEIGHT)
            btn.setCursor(Qt.PointingHandCursor)
            btn.style().unpolish(btn)
            btn.style().polish(btn)