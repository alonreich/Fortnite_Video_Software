# Project Structure Analysis

This document outlines the structure and purpose of the files within the Video Editing Software project. It is intended to be a guide for developers, especially AI agents, to understand the codebase and its dependencies.

## Project Overview

The project is a desktop application for Windows, built with Python and the PyQt5 framework. It allows users to compress, trim, and apply various effects to video files, with a focus on gaming clips (specifically Fortnite, as suggested by the naming conventions). The application is designed to be portable, bundling its dependencies like `ffmpeg` and `VLC` in the `binaries` directory. A key feature is the ability to reformat widescreen gameplay into a mobile-friendly portrait view, overlaying important HUD elements like the health bar and loot inventory onto the main video feed. The project also includes a standalone tool for merging multiple video files.

## File Tree and Descriptions

### Root Directory

- **`app.py`**
    - **Purpose**: The main entry point of the application.
    - **Details**:
        - Initializes the PyQt5 application (`QApplication`).
        - Sets up environment variables and paths for `VLC` and `ffmpeg` from the `binaries` directory.
        - Performs a check for `ffmpeg.exe` and `ffprobe.exe` on startup.
        - Probes for available hardware encoders (NVENC, QSV, AMF) and sets an environment variable (`VIDEO_FORCE_CPU`) if none are found.
        - Instantiates and shows the main application window (`VideoCompressorApp`).
    - **Dependencies**: `PyQt5`, `vlc`, `ui.main_window`, `system.logger`, `system.config`.

- **`z_Install_Fortnite_Video_Software.cmd` & `Installer.ps1`**
    - **Purpose**: Installation scripts for setting up the application on a user's machine.

- **`.gitignore`**
    - **Purpose**: Standard Git ignore file to exclude unnecessary files from version control.

### `ui/` - User Interface

- **`main_window.py`**
    - **Purpose**: The main window of the application, named `VideoCompressorApp`.
    - **Details**:
        - It's a `QWidget` that inherits from multiple "mixin" classes found in `ui/parts/`. This architectural pattern is used to separate different functionalities (UI building, player logic, event handling, etc.) into distinct files.
        - Manages the overall application state (e.g., `is_processing`).
        - Connects signals from worker threads to UI slots to update progress bars and status messages.
        - Handles file selection, loading, and saving of application configuration.
    - **Dependencies**: `PyQt5`, `vlc`, `system.config`, `system.logger`, and all mixins in `ui/parts/`.

- **`ui/parts/*.py` (Mixins)**
    - **Purpose**: These files contain specialized mixin classes that are combined to build the `VideoCompressorApp`.
    - **`ui_builder_mixin.py`**: Constructs the layout of the main window, creating and arranging all the widgets (buttons, sliders, etc.).
    - **`player_mixin.py`**: Manages the VLC media player instance, including play/pause functionality and updating the timeline slider.
    - **`trim_mixin.py`**: Handles the logic for setting video start and end trim points from the UI.
    - **`ffmpeg_mixin.py`**: Responsible for starting the `ProcessThread` (`worker.py`) and handling the results (success or failure). Contains the logic for the "Done!" dialog.
    - **`music_mixin.py`**: Manages the selection of background music from the `mp3/` folder, including the logic for the music offset dialog.
    - **`volume_mixin.py`**: Controls the main video volume slider and its badge.
    - **`phase_overlay_mixin.py`**: Manages the semi-transparent overlay that appears during video processing, which includes a performance graph.
    - **`events_mixin.py`**: Handles global mouse and keyboard events for the main window.
    - **`keyboard_mixin.py`**:
        - **Purpose**: Manages global keyboard shortcuts for the main application window.
        - **Details**:
            - Contains an `eventFilter` that intercepts key presses.
            - It now includes a check `QApplication.activeModalWidget() is not None` to prevent shortcuts from activating when a modal dialog (like a file picker) is open.
            - **Volume Control**: Handles Up/Down arrow keys for volume adjustment. The logic has been refined to ensure that the Up arrow always increases the perceived volume and the Down arrow always decreases it, regardless of whether the `QSlider` is visually inverted. This is achieved by directly calculating the new effective volume and then converting it to the appropriate raw slider value.
            - **Conditional Activation**: Volume controls are always active. Other shortcuts like 'Space' for play/pause are only active when a video (`input_file_path`) is loaded.
        - **Dependencies**: `PyQt5`, `vlc` (indirectly through player actions).

- **`ui/widgets/*.py` (Custom Widgets)**
    - **Purpose**: Reusable, custom UI components.
    - **`timeline_slider.py`**: A `QSlider` subclass that displays time markers (e.g., "1:30") along the timeline.
    - **`trimmed_slider.py`**: A `QSlider` subclass that visually indicates the selected start and end trim points with a colored bar.
    - **`drop_area.py`**: A `QFrame` that allows users to drag and drop video files to open them.
    - **`draggable_list_widget.py`**: A `QListWidget` subclass that allows items to be reordered via drag-and-drop, used in the Video Merger.
    - **`music_offset_dialog.py`**:
        - **Purpose**: A dialog for setting the start offset of background music, with a waveform preview.
        - **Details**:
            - It has its own `keyPressEvent` handler that processes Up/Down arrow keys for volume control of the music preview.
            - The volume adjustment logic mirrors the one in `keyboard_mixin.py`, ensuring consistent behavior regardless of the slider's `invertedAppearance`.
        - **Dependencies**: `PyQt5`, `vlc`, `ffmpeg` (for waveform generation).
    - **`video_merger.py`**:
        - **Purpose**: A complete, standalone tool for merging multiple video clips. It is launched as a separate top-level window from the main application.
        - **Functionality**:
            - Allows users to add multiple video files to a list.
            - Users can reorder the videos using a `DraggableListWidget`.
            - Provides an option to add background music to the merged video.
            - It uses `ffmpeg`'s `concat` demuxer for a fast, lossless merge if no audio re-encoding is needed. If music is added, it re-encodes the audio stream.
            - Presents its own "Done!" dialog upon completion.
        - **Integration**: It is launched from the main app but operates independently. It has its own event loop and UI. It reuses some configuration and the `vlc` instance from the main app.

### `processing/` - Core Logic

- **`worker.py`**
    - **Purpose**: Contains the `ProcessThread`, which performs the actual video processing using `ffmpeg`.
    - **Details**:
        - This is a `QThread`, ensuring that the main UI remains responsive during the (potentially long) encoding process.
        - It constructs a complex `ffmpeg` command line based on the user's settings (trim times, resolution, mobile format, overlays, speed, music, etc.).
        - The most complex part is the `filter_complex` argument, which dynamically builds a filter graph to:
            - Crop out HUD elements (health, stats, loot).
            - Scale and overlay them onto the main video for the portrait "Mobile Format".
            - Apply speed changes (`setpts` for video, `atempo` for audio).
            - Add fade-in/out effects.
            - Mix background music with the original audio.
        - It includes a fallback mechanism: if GPU encoding (`h264_nvenc`) fails, it automatically retries with CPU encoding (`libx264`).
    - **Dependencies**: `PyQt5`, `ffmpeg` (binary).

- **`old_before_CPU_FallBack_worker.py`**
    - **Purpose**: An older version of the worker thread, likely kept for reference or backup. It lacks the CPU fallback mechanism.

### `system/` - System-level Utilities

- **`config.py`**
    - **Purpose**: Provides the `ConfigManager` class.
    - **Details**: Handles loading and saving application settings (like window size, last used directory, and checkbox states) to a `Video.conf` JSON file.

- **`logger.py`**
    - **Purpose**: Sets up a centralized, rotating file logger.
    - **Details**: Creates a `Fortnite-Video-Converter.log` file in the `logs/` directory to record application events, errors, and debug information.

### `binaries/` - Dependencies

- **Purpose**: This directory contains all the external binaries required for the application to run, making it portable.
- **Key Files**:
    - **`ffmpeg.exe` & `ffprobe.exe`**: The core command-line tools for all video and audio manipulation and analysis. The entire processing pipeline depends on these.
    - **`libvlc.dll`, `libvlccore.dll`, and `plugins/`**: The VideoLAN VLC library and its plugins, used for video playback within the application's UI. The application sets the `VLC_PLUGIN_PATH` environment variable to ensure VLC can find its components.

### Other Directories

- **`!!!_Ouput_Video_Files_!!!/`**: The default folder where processed videos are saved.
- **`icons/`**: Contains the application's icon files (`.ico`).
- **`logs/`**: The directory where the log files are written.
- **`mp3/`**: The designated folder for users to place their background music files.

## High-Level Architecture

1.  **Entry Point (`app.py`)**: Sets up the environment and launches the main window.
2.  **UI (`ui/main_window.py` + `ui/parts/`)**: The user interacts with the main window, which is a composite of many smaller, feature-specific mixin classes. The UI is built with `ui_builder_mixin.py`.
3.  **Playback (`player_mixin.py` + `binaries/vlc`)**: The user selects a file, and the `VLC` libraries are used to play it in the `video_frame`.
4.  **Configuration (`ffmpeg_mixin.py` + `trim_mixin.py`, etc.)**: The user sets parameters like trim points, quality, and mobile format. These settings are stored as attributes on the `VideoCompressorApp` instance.
5.  **Processing (`ffmpeg_mixin.py` -> `processing/worker.py`)**: When the user clicks "Process Video", the `ffmpeg_mixin` creates and starts a `ProcessThread` from `worker.py`.
6.  **FFmpeg Execution (`worker.py` + `binaries/ffmpeg`)**: The worker thread builds a long, complex `ffmpeg` command based on the stored settings and executes it as a subprocess. It monitors the output to provide progress updates.
7.  **Completion (`ffmpeg_mixin.py`)**: The worker thread signals completion (or failure). The `ffmpeg_mixin` catches this signal and shows the "Done!" dialog or an error message.

This structure effectively separates the UI, the core processing logic, and the application's dependencies, making it a well-organized and maintainable project.
