# ==============================================================================
# PROJECT GOAL: Fortnite Video Software
# TARGET: PYTHON / DESKTOP (GPU-ENABLED)
# ==============================================================================
A high-performance, GPU-accelerated Fortnite video editor with mathematically perfect audio-visual synchronization.
The suite includes: Video Compressor (Main App), Video Merger, Crop Tool, and Advanced Editor.

# General Project Guidelines:
# 1. Modular Architecture: Files should remain focused (target 150-250 lines). 
# 2. Sync Logic: Video tempo scales with speed multiplier. Background music ALWAYS remains at a constant 1.0x tempo.
# 3. Audio Protection: Main video audio uses Volume/EQ Ducking (150Hz split) against background music.
# 4. Strict UI Rules: "No Junk" policy. All temp files (.wav, .png, .txt) must be deleted on cancel/close.
# 5. UI Spacing: Exactly 10px vertical gap above/below STEP titles. Navigation buttons are strictly 42px height.
# 6. Stability: VLC scrubbing is throttled to 20fps (50ms) to prevent native thread deadlocks.
# 7. Independence: Main App and Merger share widget logic but remain technically decoupled (local method copies).

# ==============================================================================
# COORDINATE SYSTEM & SCALING LOGIC
# ==============================================================================
# 1. UI Space: 1080x1920 (Portrait). Content Area: 1080x1620 (Excludes top 150px text canvas).
# 2. Backend Space: 1280x1920 (High-fidelity scaling before 1080p center-crop).
# 3. Transformation: Source -> 1280p Scale -> 1080p Crop -> HUD Overlay -> Encode.
# 4. Drift Prevention: Extra 1px padding on HUD selection borders (Left for Map/Stats, Right for Loot).

# ==============================================================================
# PROJECT ARCHITECTURE & FILE ROLE STRUCTURE
# ==============================================================================
.
├── app.py: Main entry point. Initializes logging, hardware scan, and launches window.
├── project_structure.txt: This file (Architecture Map).
├── README.md: Product documentation.
│
├── !!!_Output_Video_Files_!!!/: Final rendered videos.
│
├── binaries/: FFmpeg, FFprobe, and VLC native libraries.
├── config/: JSON/Conf settings (main_app.conf, crops_coordinations.conf).
├── logs/: Rotating logs (main_app.log). Captured native stderr/faulthandler output.
│
├── processing/: The core rendering engine.
│   ├── filter_builder.py: Builds complex audio/video chains (atempo, smart afade, ducking).
│   ├── worker.py: ProcessThread orchestrating the FFmpeg pipeline.
│   ├── encoders.py: GPU vs CPU codec management.
│   └── (media_utils.py, step_concat.py, step_intro.py, system_utils.py, text_ops.py)
│
├── system/: Operating system and lifecycle management.
│   ├── utils.py: ProcessManager, DependencyDoctor, and Native Console initialization.
│   └── (config.py, constants.py, logger.py, state_transfer.py)
│
├── ui/: Frontend components.
│   ├── main_window.py: The central hub of the Compressor app.
│   ├── parts/: Mixins providing modular functionality to the main window.
│   │   ├── music_mixin.py: Controls wizard launch, persistent folder selection, and auto-pause.
│   │   ├── player_mixin.py: Handles VLC playback, wall-clock sync math, and scrubbing protection.
│   │   ├── ui_builder_mixin.py: Constructs 3D-styled UI. 'ADD MUSIC' button uses nested layout.
│   │   └── (events, ffmpeg, keyboard, phase_overlay, trim, volume)
│   │
│   └── widgets/: Reusable specialized custom components.
│       ├── music_wizard.py: 3-step music engine. Sets global dark theme to break app inheritance.
│       ├── music_wizard_step_pages.py: Steps 1 & 2 layout. Folder button uses large 16px gear icons.
│       ├── music_wizard_page3.py: Step 3 Timeline preview. Dual lanes with 2px borders and 10px gap.
│       ├── music_wizard_waveform.py: Async soundwave generation and click-to-seek logic.
│       ├── music_wizard_playback.py: Synchronized wizard preview playback.
│       ├── music_wizard_misc.py: mathematically precise frameGeometry centering and persistence.
│       ├── music_wizard_constants.py: Mathematical sync values (1350ms lead, 5ms correction).
│       ├── music_wizard_widgets.py: SearchableListWidget with 1.5s multi-char type-ahead buffer.
│       ├── music_wizard_workers.py: FFmpeg background tasks (Low-res 192p thumbnail extraction).
│       ├── trimmed_slider.py: Unified axis with 15s/30s/45s markers and 2px hover-glow handle.
│       └── (clickable_button, drop_area, tooltip_manager, custom_dialogs)
│
└── utilities/: Port source for shared logic (Video Merger suite).

# ==============================================================================
# PRODUCTION SANITY TEST SUITE
# ==============================================================================

# 1. AI AGENT SANITY CHECK QUESTIONS (CORE)
# 1. CONSTANT TEMPO: Does background music always play at 1.0x speed, even if the video is accelerated or slowed?
# 2. HANDLE CLAMPING: Are pink music handles physically blocked from going outside orange video trims?
# 3. SCRUB PROTECTION: Is VLC scrubbing throttled to 20fps to prevent native thread deadlocks?
# 4. SMART FADING: Do afade durations scale down automatically for clips under 3 seconds?
# 5. GEOMETRY MEMORY: Does the wizard save geometry on every move/resize event?
# 6. TYPE-AHEAD: Can users type sequential letters (e.g. 'aki') to jump to songs in Step 1?
# 7. AUTO-PAUSE: Does the background video pause immediately when 'ADD MUSIC' is clicked?
# 8. PINK OVERLAY: Does the pink timeline line appear automatically after wizard selection?
# 9. NATIVE LOGS: Are C++ VLC crashes captured in main_app.log via faulthandler?
# 10. FOLDER PERSISTENCE: Is 'custom_mp3_dir' prioritized over default path on launch?

# 2. AI AGENT SANITY CHECK QUESTIONS (CRAZY CHALLENGING SCENARIOS)
# 1. GRANULAR SPEED SYNC: Video has 3 segments (0.5x, 2.0x, 1.1x). Music starts in seg 1, ends in seg 3. 
#    - Test: Does the wall-clock math correctly predict the audio mark in the final export despite constant 1.0x music?
# 2. IMPOSSIBLE FADE: A music clip is 0.1s long. 
#    - Test: Does the 'min(1.0, dur/3)' fade logic prevent division-by-zero or negative duration errors?
# 3. DJ SCRUBBING: User wiggles the timeline 15 times per second while playback is active.
#    - Test: Does the 50ms throttle keep the VLC audio buffer from overflowing or crashing?
# 4. NETWORK DISCONNECT: 'custom_mp3_dir' points to a drive that is unplugged.
#    - Test: Does the app gracefully fall back to the local ./mp3 folder without hanging?
# 5. TRIMMING CONFLICT: User drags orange handle INTO a pink handle.
#    - Test: Does the clamping logic correctly 'push' or 'block' the pink handle to maintain validity?
# 6. WORKER RACE: User double-clicks a song and clicks 'BACK' 0.1s later while FFmpeg is starting.
#    - Test: Is the Popen process tree (taskkill /T /F) successfully purged to prevent zombie binaries?
# 7. BITRATE EXHAUSTION: 1-second video with 320kbps MP3 at 'Bad' quality.
#    - Test: Does the calculator clamp to a safe minimum (e.g. 400k) instead of calculating a negative bitrate?
# 8. ULTRA-WIDE SCALING: 21:9 source video in Mobile Portrait mode.
#    - Test: Does the scale-out math correctly center the content while keeping HUD anchors accurate?
# 9. CONSTANT PITCH: Speed is 3.1x.
#    - Test: Does the music maintain its original pitch and speed (1.0x) while the video zooms by?
# 10. MULTI-INSTANCE CONFIG: Compressor and Merger are both open. One changes the music folder.
#     - Test: Does the second app correctly refresh its path from the .conf file without a restart?

# 3. MANUAL SANITY CHECK TASKS
# 1. FOLDER PICKER: Click 'SELECT MUSIC FOLDER', pick a path. Verify list reloads and config saves.
# 2. MULTI-CHAR SEARCH: In Step 1, type 3 letters quickly. Verify focus jumps to the exact song.
# 3. TRIMMING SYNC: Add music, then move orange trim handle. Verify pink handle 'jumps' to follow.
# 4. STEP 3 CENTERING: Delete config, open wizard. Verify Step 3 pops up in the exact screen center.
# 5. CONSTANT TEMPO: Set 2.0x video speed. Verify background music in final MP4 still sounds normal (1.0x).
# 6. HOVER GLOW: Hover over the metallic caret in Step 2. Verify the 2px blue border appears.
# 7. STEP 3 BORDERS: Check if 2px blue rectangles surround the thumbnail and waveform lanes.
# 8. VOL INDICATORS: Move sliders in Step 3. Verify white percentage labels update at the bottom.
# 9. BUTTON HEIGHTS: Verify CANCEL/BACK/DONE are all identically tall (42px).
# 10. FIRST FRAME: Arrive at Step 3. Confirm the video frame 0 is visible immediately.
