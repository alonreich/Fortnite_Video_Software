# ==============================================================================
# PROJECT GOAL: Fortnite Video Software
# TARGET: PYTHON / DESKTOP (GPU-ENABLED)
# ==============================================================================
A high-performance, GPU-accelerated Fortnite video editor with mathematically perfect audio-visual synchronization.
The suite includes: Video Compressor (Main App), Video Merger, Crop Tool, and Advanced Editor.

# General Project Guidelines:
# 1. Modular Architecture: Files should remain focused (target 150-250 lines). 
# 2. Sync Logic: Video tempo scales with speed multiplier. Background music ALWAYS remains at a constant 1.0x tempo.
# 3. Audio Protection: Main video audio uses Volume/EQ Ducking (150Hz split) against background music.
# 4. Strict UI Rules: "No Junk" policy. All temp files (.wav, .png, .txt) must be deleted on cancel/close.
# 5. UI Spacing: Exactly 10px vertical gap above/below STEP titles. Navigation buttons are strictly 42px height.
# 6. Stability: MPV scrubbing is throttled to 20fps (50ms) to prevent native thread deadlocks.
# 7. Independence: Main App and Merger share widget logic but remain technically decoupled (local method copies).

# ==============================================================================
# COORDINATE SYSTEM & SCALING LOGIC (PORTRAIT CANVAS TRICK)
# ==============================================================================
# QUICK SUMMARY:
# We do NOT compose directly at 1080x1920.
# We first compose in a larger internal canvas (1280x1920), then "zoom out / fit"
# that result into the final portrait frame. This preserves detail and keeps the top
# black strip reserved for clip text.
#
# 1) SPACES USED
#    - Final Portrait Output: 1080x1920.
#    - Visible Content Lane: 1080x1620.
#    - Reserved Text/Header Zone: top 150px (final compose places content at y=150).
#    - Internal Backend Compose Space: 1280x1920 (higher-fidelity working canvas).
#
# 2) PIPELINE (IN ORDER)
#    a. Source video is scaled + center-cropped into 1280x1920.
#    b. HUD crops/overlays are computed and composited in this same 1280x1920 space.
#    c. The full composed result is scaled down to 1080x1620.
#    d. That 1080x1620 content is placed onto a 1080x1920 black canvas at y=150.
#    e. Result: portrait output keeps the upper strip free for title/text rendering.
#
# 3) COORDINATE CONTRACTS (CRITICAL)
#    - Crop rectangles are stored in 1080x1620 CONTENT coordinates (no top-padding baked in).
#    - Overlay positions are handled in full portrait semantics and transformed with BACKEND_SCALE.
#    - BACKEND_SCALE = 1280 / 1080.
#
# 4) DRIFT PROTECTION / ROUNDING BIAS (DO NOT REMOVE)
#    - Map/Stats/Health-style regions: +1px on LEFT edge.
#    - Loot region: +1px on RIGHT edge.
#    This protects thin HUD borders from clipping due to rounding transforms.
#
# 5) SAFETY RULE
#    Do not change this math casually. It is a round-trip contract:
#    Original -> 1280x1920 internal compose -> 1080x1620 content -> 1080x1920 final frame.

# ==============================================================================
# PROJECT ARCHITECTURE & FILE ROLE STRUCTURE
# ==============================================================================
.
├── app.py: Main entry point. Initializes logging, hardware scan, and launches window.
├── project_structure.txt: This file (Architecture Map).
├── README.md: Product documentation.
│
├── !!!_Output_Video_Files_!!!/: Final rendered videos.
│
├── binaries/: FFmpeg, FFprobe, and MPV native libraries.
├── config/: JSON/Conf settings (main_app.conf, crops_coordinations.conf).
├── logs/: Rotating logs (main_app.log). Captured native stderr/faulthandler output.
│
├── processing/: The core rendering engine.
│   ├── filter_builder.py: Builds complex audio/video chains (atempo, smart afade, ducking).
│   ├── worker.py: ProcessThread orchestrating the FFmpeg pipeline.
│   ├── encoders.py: GPU vs CPU codec management.
│   └── (media_utils.py, step_concat.py, step_intro.py, system_utils.py, text_ops.py)
│
├── system/: Operating system and lifecycle management.
│   ├── utils.py: ProcessManager, DependencyDoctor, and Native Console initialization.
│   └── (config.py, constants.py, logger.py, state_transfer.py)
│
├── ui/: Frontend components.
│   ├── main_window.py: The central hub of the Compressor app.
│   ├── parts/: Mixins providing modular functionality to the main window.
│   │   ├── music_mixin.py: Controls wizard launch, persistent folder selection, and auto-pause.
│   │   ├── player_mixin.py: Handles MPV playback, wall-clock sync math, and scrubbing protection.
│   │   ├── ui_builder_mixin.py: Constructs 3D-styled UI. 'ADD MUSIC' button uses nested layout.
│   │   └── (events, ffmpeg, keyboard, phase_overlay, trim, volume)
│   │
│   └── widgets/: Reusable specialized custom components.
│       ├── music_wizard.py: 3-step music engine. Sets global dark theme to break app inheritance.
│       ├── music_wizard_step_pages.py: Steps 1 & 2 layout. Folder button uses large 16px gear icons.
│       ├── music_wizard_page3.py: Step 3 Timeline preview. Dual lanes with 2px borders and 10px gap.
│       ├── music_wizard_waveform.py: Async soundwave generation and click-to-seek logic.
│       ├── music_wizard_playback.py: Synchronized wizard preview playback.
│       ├── music_wizard_misc.py: mathematically precise frameGeometry centering and persistence.
│       ├── music_wizard_constants.py: Mathematical sync values (1350ms lead, 5ms correction).
│       ├── music_wizard_widgets.py: SearchableListWidget with 1.5s multi-char type-ahead buffer.
│       ├── music_wizard_workers.py: FFmpeg background tasks (Low-res 192p thumbnail extraction).
│       ├── trimmed_slider.py: Unified axis with 15s/30s/45s markers and 2px hover-glow handle.
│       └── (clickable_button, drop_area, tooltip_manager, custom_dialogs)
│
└── utilities/: Port source for shared logic (Video Merger suite).

# ==============================================================================
# PRODUCTION SANITY TEST SUITE
# ==============================================================================
# 3. MANUAL SANITY CHECK TASKS
# 1. FOLDER PICKER: Click 'SELECT MUSIC FOLDER', pick a path. Verify list reloads and config saves.
# 2. MULTI-CHAR SEARCH: In Step 1, type 3 letters quickly. Verify focus jumps to the exact song.
# 3. TRIMMING SYNC: Add music, then move orange trim handle. Verify pink handle 'jumps' to follow.
# 4. STEP 3 CENTERING: Delete config, open wizard. Verify Step 3 pops up in the exact screen center.
# 5. CONSTANT TEMPO: Set 2.0x video speed. Verify background music in final MP4 still sounds normal (1.0x).
# 6. HOVER GLOW: Hover over the metallic caret in Step 2. Verify the 2px blue border appears.
# 7. STEP 3 BORDERS: Check if 2px blue rectangles surround the thumbnail and waveform lanes.
# 8. VOL INDICATORS: Move sliders in Step 3. Verify white percentage labels update at the bottom.
# 9. BUTTON HEIGHTS: Verify CANCEL/BACK/DONE are all identically tall (42px).
# 10. FIRST FRAME: Arrive at Step 3. Confirm the video frame 0 is visible immediately.
