# Project Vision: Fortnite Video Crop Coordinate Configurator

## 1. Core Purpose
This desktop application, built specifically for Windows, works alongside a separate video-processing tool. Its primary function is to help creators define the precise coordinates and final placement of Heads‑Up Display (HUD) elements from a Fortnite gameplay video. These coordinates and placements are stored in a fixed JSON configuration file located in `..\processing\`, which the processing tool reads to produce perfectly cropped 9:16 portrait‑mode videos for mobile platforms. The aspect ratio is fixed at 9:16 and cannot be changed.

## 2. Core Workflow
1. **Load Sample Video:** The user loads a single video file (`.mp4`, `.avi`, `.mkv`). The tool is intended for one video at a time and supports only video file types.
2. **Navigate to a Reference Frame:** Video playback controls—play, pause, a seek bar, and keyboard shortcuts such as left/right arrow keys for frame‑accurate seeking—help the user find a frame where all HUD elements are clearly visible.
3. **Take a Snapshot:** Clicking "START CROPPING" freezes the current frame and opens the cropping interface.
4. **Define Crop Regions:** The user can mark a HUD element in two ways:
   * **Manual Drawing:** Click and drag to draw a rectangle around the HUD component.
   * **Magic Wand/Template Matching:** After taking a snapshot, the "MAGIC WAND" button becomes available. Clicking it triggers high-precision template matching using Otsu thresholding and adaptive contour detection to shrink-wrap HUD elements (Loot Area, Mini Map + Stats, Health Bar, Teammates Health, Spectating Eye). Suggested regions are overlaid on the snapshot; the user can cycle through detected regions.
5. **Tag Element:** Once a rectangle is defined, the user tags it with one of several Fortnite-specific preset roles: "Loot Area", "Mini Map + Stats", "Own Health Bar (HP)", "Boss HP (For When You Are The Boss Character)", "Teammates health Bars (HP)", or "Spectating Eye". Note: Health Bar includes both health and shield components as they are combined in Fortnite. The "Spectating Eye" represents the viewer count.
6. **Fine‑Tune in Portrait Composer:** Immediately after tagging, focus shifts to the integrated Portrait Composer pane. The element is auto‑placed based on its role. The user can drag it to reposition and use responsive handles to resize it. Visual indicators show element roles and dynamic Layer ranks (Layer 1 = Top-most).
7. **Repeat for All Elements:** Steps 4–6 are repeated for each HUD component. When saving, the application surgically updates the JSON configuration, preserving unselected elements while maintaining atomic safety with file locking and a persistent "old_crops_coordinations.conf" backup.

## 3. Key Features & Logic
* **Undo/Redo:** Comprehensive undo/redo stack for all cropping, moving, resizing, and layering actions via `Ctrl+Z`, `Ctrl+Y`, or UI buttons. Redo stack integrity is protected during operations.
* **Configuration Management:** Surgical JSON updates in `..\processing\` with atomic `os.replace` safety. Automatic persistent backup to `old_crops_coordinations.conf`.
* **Coordinate Validation:** Crops are validated to ensure they lie within the video frame and have reasonable HUD proportions to prevent overshadowing.
* **Responsive UI:** Adaptive 1800x900 initial window size. High DPI scaling support for 4K monitors. FIFO log rotation limited to 10MB.
* **Dynamic Layering:** Real-time Z-order management with "LAYER X" indicators (1 = Top). Spectating Eye defaults to the top-most layer.
* **Ghosting Support:** "Show Existing Crops" displays previously saved elements with adjustable transparency and role-based color coding.
* **VLC Integration:** Robust background resolution detection and frame-accurate seeking using VLC 64-bit.
* **Magic Wand Precision:** Aggressive shrink-wrapping logic ensures boxes are perfectly sized to the HUD content, not just general areas.
* **Clean State:** "RESET ALL" performs a factory-reset of the session, purging all temporary files and clearing the canvas to pitch-black.

# ==============================================================================
# COORDINATE SYSTEM & SCALING LOGIC (CRITICAL FOR AI AGENTS)
# ==============================================================================
# The Crop Tool and Processing Engine usage a unique "Scale-Out" architecture to ensure high quality.
#
# 1. THE UI SPACE (1080x1920, WITH 1080x1620 CONTENT AREA):
#    - The Crop Tool's Portrait View uses a 1080x1920 canvas.
#    - The Top 150 pixels (y=0 to y=150) are STRICTLY RESERVED for the text/header canvas.
#    - HUD elements are constrained to the 1080x1620 CONTENT AREA (y=150..1920).
#    - IMPORTANT: crops_coordinations.conf stores crop rectangles in the CONTENT AREA
#      coordinate space (1080x1620), i.e., y is relative to the content area and does
#      NOT include the top 150px padding. Overlay positions are stored in full 1080x1920.
#
# 2. THE PROCESSING SPACE (1280x1920):
#    - The backend (filter_builder.py) scales the main video to 1280x1920 (TARGET_W=1280) first.
#    - This scaling (1280p) is larger than the UI space (1080p).
#    - Why? To allow the 1080p content to be "centered" or manipulated with high fidelity before final output.
#
# 3. THE TRANSFORMATION PIPELINE:
#    - CONFIG -> BACKEND (1280x1920 canvas):
#         a. Crop Rect (content area): X_canvas = X_content * BACKEND_SCALE
#         b. Crop Rect (content area): Y_canvas = Y_content * BACKEND_SCALE
#         c. Element Size: Size_canvas = (Size_content * user_scale) * BACKEND_SCALE
#    - BACKEND -> FFmpeg:
#         a. The *Source Crop* is computed by inverting the content-area transform back
#            to the original resolution using the same scale+center-crop math as FFmpeg.
#         b. The *Overlay Position* is computed by scaling overlay x,y from 1080x1920
#            to 1280x1920, and then subtracting the 150px top padding after scaling.
#         c. The *Element Size* is also scaled to 1280x1920 to preserve relative size.
#
# 4. KEY TAKEAWAY:
#    - Crop rectangles are stored in 1080x1620 content space; overlay positions are in 1080x1920.
#    - The 150px top padding is applied ONLY to overlay positioning, not crop rectangles.
#    - Do NOT remove the top-bar restriction; it protects the text layer.
#    - Do NOT change the scaling logic without understanding the full round-trip:
#      Original -> 1280x1920 (scale+crop) -> 1080x1620 content -> config -> back to original.
#
# 5. DRIFT PROTECTION / PREVENTION:
#    - To prevent mathematical drift during coordinate transformation and stay on the safe side:
#      a. Mini Map + Stats: An additional extra 1 pixel is added to the LEFT of the selection.
#      b. Loot Area: An additional extra 1 pixel is added to the RIGHT of the selection.
#    - This ensures HUD borders remain crisp and no content is clipped by rounding errors.
# ==============================================================================