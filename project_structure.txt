# ==============================================================================
# PROJECT GOAL: Fortnite Video Software
# TARGET: PYTHON / DESKTOP (GPU-ENABLED)
# ==============================================================================
A quick, free-to-use, ad-free, GPU-accelerated desktop video editor designed for creating and sharing cool Fortnite video clips with family and friends.
The suite is divided into four main applications: Video Compressor, Video Merger, Crop Tool, and an Advanced Video Editor.

# General Project Guidelines:
# 1. To maintain readability and focus, each code/script file should not exceed 150-200 lines. Logic should be divided into multiple separate files.
# 2. This file (.\project_structure.txt) must be kept up-to-date, reflecting all changes in the project structure.
# 3. Video tempo scales with the speed multiplier, but audio pitch and background music tempo remain constant.
# 4. To ensure dialogue and in-game sounds are clear, the main video's audio is protected using "Volume Ducking" and "EQ Ducking" against the background music.
#    - Volume Ducking: When the main audio exceeds -16.5 dB (a threshold of 0.15), the background music volume is compressed at a 2.5:1 ratio.
#    - EQ Ducking: The music is split at 150 Hz. Ducking is applied only to frequencies above 150 Hz, preserving the music's bassline while carving out space for the main audio.
# 5. Code should be written without comments for a clean and uncluttered codebase.

# Manual Pip Management:
# To upgrade pip: "%LOCALAPPDATA%\Programs\Python\Python313\python.exe" -m pip install --upgrade pip
# To install packages: "%LOCALAPPDATA%\Programs\Python\Python313\python.exe" -m pip install PyQt5 psutil python-vlc send2trash

# ==============================================================================
# COORDINATE SYSTEM & SCALING LOGIC (CRITICAL FOR AI AGENTS)
# ==============================================================================
# The Crop Tool and Processing Engine usage a unique "Scale-Out" architecture to ensure high quality.
#
# 1. THE UI SPACE (1080x1920, WITH 1080x1620 CONTENT AREA):
#    - The Crop Tool's Portrait View uses a 1080x1920 canvas.
#    - The Top 150 pixels (y=0 to y=150) are STRICTLY RESERVED for the text/header canvas.
#    - HUD elements are constrained to the 1080x1620 CONTENT AREA (y=150..1920).
#    - IMPORTANT: crops_coordinations.conf stores crop rectangles in the CONTENT AREA
#      coordinate space (1080x1620), i.e., y is relative to the content area and does
#      NOT include the top 150px padding. Overlay positions are stored in full 1080x1920.
#
# 2. THE PROCESSING SPACE (1280x1920):
#    - The backend (filter_builder.py) scales the main video to 1280x1920 (TARGET_W=1280) first.
#    - This scaling (1280p) is larger than the UI space (1080p).
#    - Why? To allow the 1080p content to be "centered" or manipulated with high fidelity before final output.
#
# 3. THE TRANSFORMATION PIPELINE:
#    - CONFIG -> BACKEND (1280x1920 canvas):
#         a. Crop Rect (content area): X_canvas = X_content * BACKEND_SCALE
#         b. Crop Rect (content area): Y_canvas = Y_content * BACKEND_SCALE
#         c. Element Size: Size_canvas = (Size_content * user_scale) * BACKEND_SCALE
#    - BACKEND -> FFmpeg:
#         a. The *Source Crop* is computed by inverting the content-area transform back
#            to the original resolution using the same scale+center-crop math as FFmpeg.
#         b. The *Overlay Position* is computed by scaling overlay x,y from 1080x1920
#            to 1280x1920, and then subtracting the 150px top padding after scaling.
#         c. The *Element Size* is also scaled to 1280x1920 to preserve relative size.
#
# 4. KEY TAKEAWAY:
#    - Crop rectangles are stored in 1080x1620 content space; overlay positions are in 1080x1920.
#    - The 150px top padding is applied ONLY to overlay positioning, not crop rectangles.
#    - Do NOT remove the top-bar restriction; it protects the text layer.
#    - Do NOT change the scaling logic without understanding the full round-trip:
#      Original -> 1280x1920 (scale+crop) -> 1080x1620 content -> config -> back to original.

# ==============================================================================
# PROJECT ARCHITECTURE & FILE ROLE STRUCTURE
# ==============================================================================
.
├── app.py: Main entry point for the application. Launches the main window.
├── README.md: Contains information about the project.
├── project_structure.txt: This file, containing a map and description of the project structure.
├── .gitignore: Specifies files and directories to be ignored by Git.
├── .gitattributes: Specifies attributes for paths.
├── Fix OS Problems.cmd: A command script to fix OS related problems.
├── Installer.ps1: A PowerShell script for one-click installation and updates.
├── z_Install_Fortnite_Video_Software.cmd: A command script to installation.
│
├── !!!_Ouput_Video_Files_!!!/: Default output directory for processed videos.
│
├── advanced/: A separate, multi-track video editor application.
│   ├── (Content from .\advanced\project_structure.txt)
│
├── binaries/: Contains all the necessary binaries for the application to run (ffmpeg, vlc, etc.).
│
├── config/: Contains configuration files for the applications.
│
├── developer_tools/: Tools for development purposes.
│   ├── app_handlers.py: Handles events for the crop tool application.
│   ├── cleaner.py: A script to clean python files by removing comments.
│   ├── config.py: Configuration for the developer tools.
│   ├── crop_tools.py: The main entry point for the crop tool application.
│   ├── crop_widgets.py: Widgets used in the crop tool.
│   ├── Find_and_Remove_Comments.py: A script to find and remove comments from python files.
│   ├── graphics_items.py: Custom graphics items for the crop tool.
│   ├── Keyboard_Mixing.py: A mixin for keyboard shortcuts.
│   ├── logger_setup.py: Sets up the logger for the developer tools.
│   ├── media_processor.py: Processes media for the crop tool.
│   ├── portrait_window.py: The portrait window for the crop tool.
│   ├── ui_setup.py: Sets up the UI for the crop tool.
│   ├── utils.py: Utility functions for the developer tools.
│   ├── audio_compressor.py: Tool for audio compression.
│
├── icons/: Contains application icons.
│   └── Video_Icon_File.ico
│
├── logs/: Directory for application log files.
│
├── mp3/: Directory for background music MP3 files.
│
├── processing/: The core video processing logic.
│   ├── config_data.py: Manages video configuration, crop coordinates, and quality settings.
│   ├── crops_coordinations.conf: Configuration file for external crop coordinates (referenced by config_data.py).
│   ├── encoders.py: Manages hardware/CPU encoder selection and codec flags.
│   ├── filter_builder.py: Constructs complex FFmpeg filter graphs for video/audio processing. Responsible for Volume Ducking + EQ Ducking/Carving.
│   ├── media_utils.py: Utilities for media probing (ffprobe) and bitrate calculations.
│   ├── step_concat.py: Handles the final concatenation of video parts.
│   ├── step_intro.py: Generates the intro sequence for the video.
│   ├── system_utils.py: System-level utilities for subprocess handling, time parsing, and progress monitoring.
│   ├── text_ops.py: Handles text formatting, wrapping, and bidirectional (Hebrew) support.
│   └── worker.py: The central worker thread orchestrating the rendering pipeline.
│
├── system/: System-level modules for the main application.
│   ├── config.py: Manages application configuration.
│   └── logger.py: Sets up the logger for the application.
│
├── ui/: The user interface for the main application.
│   ├── main_window.py: The main window of the application.
│   ├── parts/: Mixins for the main window.
│   │   ├── events_mixin.py: Mixin for handling events.
│   │   ├── ffmpeg_mixin.py: Mixin for handling ffmpeg processes.





# ==============================================================================
# PRODUCTION SANITY TEST SUITE (STRICT QUALITY ASSURANCE)
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. AI AGENT SANITY CHECK QUESTIONS (20 MOST IMPORTANT)
# ------------------------------------------------------------------------------
# 1. GPU PREFERENCE: Does the app always prioritize GPU (NVENC/AMF/QSV) over CPU for heavy encoding tasks?
# 2. FAILBACK LOGIC: Does the app successfully fallback to CPU-only (libx264) if no compatible GPU is detected?
# 3. MULTI-VENDOR GPU: Does the app work correctly on AMD and Intel GPUs, not just NVIDIA?
# 4. AUDIO PARITY: Is the output audio quality identical or the closest possible match to the original source?
# 5. RESIDUE CLEANUP: Are all temporary files (.mp4, .txt, .log) deleted from Temp, especially after clicking 'CANCEL'?
# 6. ATEMPO LIMITS: Does the app strictly use 'atempo' for all speed changes, and stay within the 0.5x - 3.1x range?
# 7. WAVELENGTH SOURCE: Is 'ffmpeg showwaves' used for audio visualizers? Is it more efficient than manual Python draws?
# 8. PIP REDUCTION: Are unnecessary packages like 'pynput' or 'PyQtWebEngine' removed to keep the installation lean?
# 9. BITRATE INTELLIGENCE: Do short videos (<5s) at 'Maximum' quality correctly avoid exceeding the source file size?
# 10. MUSIC OFFSET MATH: Does the app accurately calculate music stop points when pink offset handles + Granular Speeds are used?
# 11. ASPECT RATIO MATH: Do 16:9 sources at any resolution (720p to 4K) maintain perfect HUD anchor scaling?
# 12. SHELL OVERFLOW: Are all FFmpeg complex filters passed via .txt script files to bypass Windows character limits?
# 13. BIDI WRAPPING: Do mixed RTL/LTR Hebrew/English strings wrap correctly within the 150px top-bar?
# 14. RESOURCE LEAKS: Is system memory (RAM) fully released after the 'ProcessThread' finishes a job?
# 15. TEMPLATE MATCHING: Is 'Magic Wand' accuracy verified against the latest Fortnite season HUD reference images?
# 16. STRATEGY FEEDBACK: Does the status bar correctly report the finalized hardware strategy (e.g., '✅ NVENC Enabled')?
# 17. PROBE ROBUSTNESS: Does the app handle corrupted 0-byte or non-video files without crashing?
# 18. CONFIG RECOVERY: Does the app reset to 1500x800 centered if the 'Config' folder or 'main_app.conf' is deleted?
# 19. PERMISSION HANDLING: Does the app report an error if the output directory is read-only or protected?
# 20. GPU PUSH: Can the processing (e.g., filters/scaling) be pushed further into the GPU pipeline (OpenCL/CUDA)?

# ------------------------------------------------------------------------------
# 2. MANUAL SANITY CHECK TASKS (20 MOST IMPORTANT)
# ------------------------------------------------------------------------------
# 1. QUALITY CHECK: Upload a video, move quality slider to 'Standard'. Verify output is approx 45MB.
# 2. MUSIC MIX: Add MP3 background music. Verify processing succeeds and music is audible/ducked.
# 3. SPEED SYNC: Set speed to 3.0. Verify video and audio remain perfectly synced until the very end.
# 4. PORTRAIT BAD: Process 'Bad' quality in both Landscape and Portrait. Verify both are 10MB-15MB.
# 5. MERGER TEST: Join 2 videos + music in Merger. Verify no audio pops or visual gaps at the transition.
# 6. HIDDEN CONSOLE: Launch all 3 apps (Merger, Compressor, Crop). Verify NO black CMD windows appear.
# 7. GHOST PROCESS: Open Editor -> Merger -> Close All. Verify no 'cmd.exe' or 'python.exe' remains in Task Manager.
# 8. CONFIG RESET: Delete .\Config\ folder. Verify window centers and all settings return to defaults.
# 9. MUSIC OVERLAP: Use music shorter than the video. Verify it stops/fades out before the video trim end.
# 10. THUMBNAIL SPEED: Set 1.2x speed. Pick thumbnail. Verify the image matches the playhead frame exactly.
# 11. GRANULAR EDIT: Edit segments, save, re-open. Verify segments are remembered and still editable.
# 12. BOSS HP SHIFT: Toggle 'Boss HP'. Verify HUD crops in Portrait View shift to the correct boss positions.
# 13. HOVER BADGES: Hover over Volume handles. Verify the % badge appears and updates correctly.
# 14. CANCEL REACTION: Start processing and click 'CANCEL' immediately. Verify app returns to 'Ready'.
# 15. HEBREW CENTERING: Type Hebrew in Mobile Format. Verify it is centered correctly in the final video.
# 16. TRIM PRECISION: Drag trim handles to 0.1s precision. Verify FFmpeg cuts at the exact requested time.
# 17. DRAG & DROP: Drop a file from a network drive or different partition. Verify it loads successfully.
# 18. MULTI-MONITOR: Move app to Monitor 2. Open Editor. Verify it opens on Monitor 2, not Monitor 1.
# 19. HARDWARE SCAN: Watch launch. Verify 'Scanning...' status bar message appears then changes to 'Ready'.
# 20. APP SWITCHING: Use F11/F12 to jump between apps. Verify the current video file follows you.