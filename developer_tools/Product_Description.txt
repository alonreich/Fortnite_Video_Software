# Project Vision: Fortnite Video Crop Coordinate Configurator

## 1. Core Purpose
This desktop application, built specifically for Windows, works alongside a separate video-processing tool. Its primary function is to help creators define the precise coordinates and final placement of Heads‑Up Display (HUD) elements from a Fortnite gameplay video. These coordinates and placements are stored in a fixed JSON configuration file located in `..\processing\`, which the processing tool reads to produce perfectly cropped 9:16 portrait‑mode videos for mobile platforms. The aspect ratio is fixed at 9:16 and cannot be changed.

## 2. Core Workflow
1. **Load Sample Video:** The user loads a single video file (`.mp4`, `.avi`, `.mkv`). The tool is intended for one video at a time and supports only video file types.
2. **Navigate to a Reference Frame:** Video playback controls—play, pause, a seek bar, and keyboard shortcuts such as left/right arrow keys for frame‑accurate seeking—help the user find a frame where all HUD elements are clearly visible.
3. **Take a Snapshot:** Clicking "START CROPPING" freezes the current frame and opens the cropping interface.
4. **Define Crop Regions:** The user can mark a HUD element in two ways:
   * **Manual Drawing:** Click and drag to draw a rectangle around the HUD component.
   * **Magic Wand/Template Matching:** After taking a snapshot, the "MAGIC WAND" button becomes available. Clicking it triggers template matching using anchor images to detect common Fortnite HUD elements (Loot Area, Mini Map + Stats, Health Bar, Teammates Health). Suggested regions are overlaid on the snapshot; the user can cycle through detected regions.
5. **Tag Element:** Once a rectangle is defined, the user tags it with one of several Fortnite-specific preset roles: "Loot Area", "Mini Map + Stats", "Own Health Bar (HP)", "Boss HP (For When You Are The Boss Character)", or "Teammates health Bars (HP)". Note: Health Bar includes both health and shield components as they are combined in Fortnite.
6. **Fine‑Tune in Portrait Composer:** Immediately after tagging, focus shifts to a separate "Portrait Composer" window (titled "Portrait 1280x1920"), showing the selected element on a 9:16 canvas. The element is auto‑placed based on its role (e.g., loot goes bottom-right, health goes bottom-left). The user can drag it to reposition and use handles to resize it, defining its final scale and location within the portrait layout. **NOTHING IS SAVED UNTIL** the user clicks **"FINISH & SAVE"**.
7. **Repeat for All Elements:** Steps 4–6 are repeated for each HUD component that the user wants to appear in the portrait video. When saving, the application surgically updates only the HUD elements that were present in the portrait composer, leaving other configured elements untouched.

## 3. Key Features & Logic
* **Undo/Redo:** Cropping actions can be undone or redone via `Ctrl+Z` and `Ctrl+Y` (with functional undo/redo buttons).
* **Configuration Management:** The application writes coordinate and placement data to a JSON file in `..\processing\` **only when the user clicks "FINISH & SAVE"**. It performs surgical updates—modifying only elements present in the portrait composer while preserving others.
* **Coordinate Validation:** Crops are validated to ensure they lie within the video frame; invalid coordinates trigger an error.
* **Guided UI:** A blinking text overlay appears at each step to guide the user on what to do next. No sidebar is used.
* **Preset HUD Roles:** Fortnite-specific HUD roles are preconfigured: Loot Area, Mini Map + Stats, Own Health Bar (HP), Boss HP, Teammates health Bars (HP).
* **No Caching:** The implementation avoids generating cache files (e.g., `__pycache__`) using environment variables.
* **Fortnite‑Specific:** The tool is tailored for Fortnite with game-specific HUD detection and does not support other games.
* **Accessibility:** The interface supports keyboard navigation (arrow keys for frame seeking and element movement in portrait composer).
* **Zoom Limits:** Both landscape and portrait windows prevent zooming out beyond the point where black voids/empty space would appear around the image.
* **UI Consistency:** All buttons have consistent heights, colors, and sizing. Window titles are standardized: "Crop Tool Wizard" for main window, "Portrait 1280x1920" for portrait composer.

# ==============================================================================
# COORDINATE SYSTEM & SCALING LOGIC (CRITICAL FOR AI AGENTS)
# ==============================================================================
# The Crop Tool and Processing Engine usage a unique "Scale-Out" architecture to ensure high quality.
#
# 1. THE UI SPACE (1080x1920):
#    - The Crop Tool's Portrait View operates in a 1080x1920 coordinate space (CONTENT_W=1080).
#    - The Top 150 pixels (y=0 to y=150) are STRICTLY RESERVED for the text/header canvas.
#    - Users are prevented from moving HUD elements into this top area. This is INTENTIONAL.
#    - The configuration file (crops_coordinations.conf) stores coordinates in this 1080p space.
#
# 2. THE PROCESSING SPACE (1280x1920):
#    - The backend (filter_builder.py) scales the main video to 1280x1920 (TARGET_W=1280) first.
#    - This scaling (1280p) is larger than the UI space (1080p).
#    - Why? To allow the 1080p content to be "centered" or manipulated with high fidelity before final output.
#
# 3. THE TRANSFORMATION PIPELINE:
#    - CONFIG -> BACKEND: Coordinates read from config (1080p) must be mapped to the 1280p canvas.
#         a. X_canvas = X_config * BACKEND_SCALE
#         b. Y_canvas = (Y_config - 150) * BACKEND_SCALE
#         c. Element_Size = Size_UI * BACKEND_SCALE (Where Size_UI = Size_Orig * user_scale)
#    - BACKEND -> FFmpeg:
#         a. The *Source Crop* is calculated by INVERTING the 1080p transform back to Original Resolution (e.g. 1920x1080).
#         b. The *Overlay Position* is calculated by scaling the config x,y (1080p) UP to 1280p space.
#         c. The *Element Size* (scale=...) must ALSO be scaled UP to 1280p space to maintain relative size.
#
# 4. KEY TAKEAWAY:
#    - If you see "1080" vs "1280" mismatches, check if it's the UI (1080) vs Backend (1280).
#    - Do NOT remove the "Top Bar" restriction; it protects the text layer.
#    - Do NOT change the scaling logic without understanding the Full Round-Trip (Original -> 1080p Config -> 1280p Canvas -> Final Video).